{% extends "base.html" %}

{% block title %}FeedWise - Chat con AI{% endblock %}

{% block styles %}
.chat-container {
    display: flex;
    flex-direction: column;
    min-height: 70vh;
}
.chat-messages {
    flex: 1;
    min-height: 400px;
    max-height: calc(100vh - 250px);
    overflow-y: auto;
    padding: 20px;
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}
.message {
    margin-bottom: 20px;
    display: flex;
}
.message-content {
    padding: 12px 16px;
    border-radius: 10px;
    max-width: 80%;
}
.user-message {
    justify-content: flex-end;
}
.user-message .message-content {
    background-color: #007bff;
    color: white;
    margin-left: auto;
}
.assistant-message .message-content {
    background-color: #e9ecef;
    color: #212529;
}
.message-input-container {
    position: relative;
    margin-bottom: 20px;
}
.message-input {
    padding-right: 60px;
    border-radius: 20px;
    resize: none;
    overflow: hidden;
    min-height: 50px;
    max-height: 120px;
    line-height: 1.5;
}
.send-button {
    position: absolute;
    right: 10px;
    bottom: 8px;
    background: none;
    border: none;
    color: #007bff;
    font-size: 24px;
    cursor: pointer;
}
.send-button:disabled {
    color: #b0b0b0;
    cursor: not-allowed;
}
.message-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 5px;
    text-align: right;
}
.loading-indicator {
    display: inline-block;
    position: relative;
    width: 80px;
    height: 20px;
}
.loading-indicator div {
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #007bff;
    animation-timing-function: cubic-bezier(0, 1, 1, 0);
}
.loading-indicator div:nth-child(1) {
    left: 8px;
    animation: loading-indicator1 0.6s infinite;
}
.loading-indicator div:nth-child(2) {
    left: 8px;
    animation: loading-indicator2 0.6s infinite;
}
.loading-indicator div:nth-child(3) {
    left: 32px;
    animation: loading-indicator2 0.6s infinite;
}
.loading-indicator div:nth-child(4) {
    left: 56px;
    animation: loading-indicator3 0.6s infinite;
}
@keyframes loading-indicator1 {
    0% { transform: scale(0); }
    100% { transform: scale(1); }
}
@keyframes loading-indicator3 {
    0% { transform: scale(1); }
    100% { transform: scale(0); }
}
@keyframes loading-indicator2 {
    0% { transform: translate(0, 0); }
    100% { transform: translate(24px, 0); }
}
.examples-section {
    margin-bottom: 20px;
}
.example-pill {
    display: inline-block;
    margin: 0.25rem;
    padding: 0.5rem 1rem;
    background-color: #e9ecef;
    border-radius: 20px;
    color: #212529;
    cursor: pointer;
    transition: background-color 0.3s;
}
.example-pill:hover {
    background-color: #dee2e6;
}
.conversation-info {
    font-size: 0.8rem;
    color: #6c757d;
    text-align: center;
    margin-top: 10px;
}
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h1 class="h2">Assistente Catalogo AI</h1>
        <p class="text-muted">Chiedi informazioni sui prodotti nel nostro catalogo!</p>
    </div>
</div>

<div class="examples-section">
    <p><small>Esempi di domande che puoi fare:</small></p>
    <div class="example-pills">
        <span class="example-pill" onclick="useExample(this)">Dammi informazioni sul prodotto MENAPPCEM</span>
        <span class="example-pill" onclick="useExample(this)">Mostrami i tavoli disponibili</span>
        <span class="example-pill" onclick="useExample(this)">Quali prodotti sono sotto i 100 euro?</span>
        <span class="example-pill" onclick="useExample(this)">Ci sono state modifiche recenti al catalogo?</span>
        <span class="example-pill" onclick="useExample(this)">Dammi le statistiche del catalogo</span>
    </div>
</div>

<div class="chat-container">
    <div class="chat-messages" id="chatMessages">
        <!-- I messaggi della chat verranno aggiunti qui -->
    </div>

    <div class="message-input-container">
        <textarea class="form-control message-input" id="messageInput" placeholder="Scrivi un messaggio..." rows="1"></textarea>
        <button class="send-button" id="sendButton" disabled>
            <i class="bi bi-send-fill"></i>
        </button>
    </div>

    <div class="conversation-info">
        Le conversazioni non vengono salvate e vengono eliminate alla chiusura della pagina.
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        
        let conversationHistory = [];
        
        // Adatta l'altezza della textarea automaticamente
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            
            // Abilita/disabilita il bottone di invio
            sendButton.disabled = this.value.trim() === '';
        });
        
        // Evento Enter per inviare il messaggio (Shift+Enter per andare a capo)
        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (!sendButton.disabled) {
                    sendMessage();
                }
            }
        });
        
        // Click sul bottone di invio
        sendButton.addEventListener('click', sendMessage);
        
        // Mostra messaggio di benvenuto dall'assistente
        function showWelcomeMessage() {
            const welcomeMessage = "Ciao! Sono l'assistente AI di FeedWise, esperto del catalogo Mobili Fiver. Posso aiutarti a trovare informazioni sui prodotti, prezzi, disponibilità e altro ancora. Come posso aiutarti oggi?";
            addMessage('assistant', welcomeMessage);
            
            // Aggiungi alla cronologia della conversazione
            conversationHistory.push({
                role: 'assistant',
                content: welcomeMessage
            });
        }
        
        // Funzione per inviare un messaggio
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message === '') return;
            
            // Aggiungi il messaggio dell'utente alla chat
            addMessage('user', message);
            
            // Aggiungi alla cronologia della conversazione
            conversationHistory.push({
                role: 'user',
                content: message
            });
            
            // Resetta l'input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            sendButton.disabled = true;
            
            // Mostra indicatore di caricamento
            showLoadingIndicator();
            
            // Chiama l'API per ottenere la risposta
            fetchResponse(message);
        }
        
        // Funzione per aggiungere un messaggio alla chat
        function addMessage(role, content) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${role}-message`;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageElement.innerHTML = `
                <div class="message-content">
                    ${content}
                    <div class="message-time">${timeStr}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageElement);
            
            // Scroll alla fine della chat
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Funzione per mostrare l'indicatore di caricamento
        function showLoadingIndicator() {
            const loadingElement = document.createElement('div');
            loadingElement.className = 'message assistant-message';
            loadingElement.id = 'loadingIndicator';
            
            loadingElement.innerHTML = `
                <div class="message-content">
                    <div class="loading-indicator">
                        <div></div><div></div><div></div><div></div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(loadingElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Funzione per rimuovere l'indicatore di caricamento
        function removeLoadingIndicator() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }
        
        // Funzione per ottenere la risposta dall'API
        function fetchResponse(message) {
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    conversation_history: conversationHistory
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nella richiesta API');
                }
                return response.json();
            })
            .then(data => {
                // Rimuovi l'indicatore di caricamento
                removeLoadingIndicator();
                
                // Aggiungi la risposta dell'assistente alla chat
                addMessage('assistant', data.response);
                
                // Aggiungi alla cronologia della conversazione
                conversationHistory.push({
                    role: 'assistant',
                    content: data.response
                });
                
                // Limita la dimensione della cronologia
                if (conversationHistory.length > 12) {
                    conversationHistory = conversationHistory.slice(-12);
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                removeLoadingIndicator();
                
                // Mostra messaggio di errore
                addMessage('assistant', 'Mi dispiace, si è verificato un errore nella comunicazione. Riprova più tardi.');
            });
        }
        
        // Funzione per usare un esempio
        window.useExample = function(element) {
            const exampleText = element.textContent;
            messageInput.value = exampleText;
            messageInput.dispatchEvent(new Event('input'));
            messageInput.focus();
        };
        
        // Mostra il messaggio di benvenuto all'avvio
        showWelcomeMessage();
    });
</script>
{% endblock %}